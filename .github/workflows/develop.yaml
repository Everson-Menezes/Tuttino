name: 2 - [Develop] Deploy to Development Environment

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  deploy-if-merged:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Terraform (opcional, se nÃ£o tiver global)
        uses: hashicorp/setup-terraform@v3

      - name: âš™ï¸ Terraform Init
        run: terraform -chdir=infra init

      - name: ğŸ” Terraform Plan
        run: terraform -chdir=infra plan

      - name: ğŸ§¹ Remove existing Docker network if exists
        run: docker network rm tuttino_net || true        

      - name: ğŸš€ Terraform Apply
        run: terraform -chdir=infra apply -auto-approve

      - name: ğŸ³ Docker Compose Rebuild and Restart
        run: |
          docker-compose down --remove-orphans
          docker-compose pull || true  # ignora se nÃ£o houver imagens remotas
          docker-compose up -d --build