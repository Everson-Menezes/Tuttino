name: 2 - [Develop] Deploy to Development Environment

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  deploy-if-merged:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    runs-on: self-hosted

    steps:
      - name: ğŸ§¹ Cleanup orphan pyc/cache files
        run: |
          sudo find /home/everson/actions-runner/_work -type f -name "*.pyc" -delete || true
          sudo find /home/everson/actions-runner/_work -type d -name "__pycache__" -exec rm -rf {} + || true

      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: âš™ï¸ Terraform Init
        run: terraform -chdir=infra init

      - name: ğŸ” Terraform Plan
        run: terraform -chdir=infra plan

      - name: ğŸ§¹ Remove existing Docker network if exists
        run: docker network rm tuttino_net || true

      - name: ğŸ§¹ Cleanup existing containers
        run: |
          docker rm -f tuttino-postgres || true
          docker rm -f tuttino-backend || true
          docker rm -f tuttino-nginx || true

      - name: ğŸš€ Terraform Apply
        run: terraform -chdir=infra apply -auto-approve

      - name: ğŸ³ Build Docker Image
        run: docker build -t tuttino-backend:latest -f backend/dockerfile ./backend

      - name: ğŸ³ Create Docker Network
        run: docker network create tuttino_net || true        
