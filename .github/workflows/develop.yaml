name: 2 - [Develop] Deploy to Development Environment

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  deploy-if-merged:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    runs-on: self-hosted

    steps:
      - name: 📥 Checkout source
        uses: actions/checkout@v4

      - name: 🧰 Set up Terraform (opcional, se não tiver global)
        uses: hashicorp/setup-terraform@v3

      - name: ⚙️ Terraform Init
        run: terraform -chdir=infra init

      - name: 🔍 Terraform Plan
        run: terraform -chdir=infra plan

      - name: 🧹 Remove existing Docker network if exists
        run: docker network rm tuttino_net || true        

      - name: 🚀 Terraform Apply
        run: terraform -chdir=infra apply -auto-approve

      - name: 🐳 Docker Compose Rebuild and Restart
        run: |
          docker-compose down --remove-orphans
          docker-compose pull || true  # ignora se não houver imagens remotas
          docker-compose up -d --build