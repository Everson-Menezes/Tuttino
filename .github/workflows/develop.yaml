name: 2 - [Develop] Deploy to Development Environment

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  filter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    outputs:
      backend_changed: ${{ steps.filter.outputs.backend }}
      infra_changed: ${{ steps.filter.outputs.infra }}

    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: ğŸ“‚ Check changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            infra:
              - 'infra/**'

  Merge-Validation:
    needs: filter
    if: >
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'feature/') &&
      (needs.filter.outputs.infra_changed == 'true' || needs.filter.outputs.backend_changed == 'true')
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: âš™ï¸ Terraform Init
        run: terraform -chdir=infra init

      - name: ğŸ” Terraform Plan
        run: terraform -chdir=infra plan

      - name: ğŸš€ Terraform Apply
        run: terraform -chdir=infra apply -auto-approve

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Cache Docker layers (backend)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-backend-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-backend-

      - name: ğŸ³ Build Backend Image with Cache
        run: |
          docker build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache \
            -t tuttino-backend:latest \
            -f backend/dockerfile backend
