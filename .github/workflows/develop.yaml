name: 2 - [Develop] Deploy to Development Environment

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  deploy-if-merged:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'feature/')
    runs-on: self-hosted

    steps:
      - name: 📥 Checkout source
        uses: actions/checkout@v4

      - name: 🧰 Set up Terraform (opcional, se não tiver global)
        uses: hashicorp/setup-terraform@v3

      - name: ⚙️ Terraform Init
        run: terraform -chdir=infra init

      - name: 🔍 Terraform Plan
        run: terraform -chdir=infra plan

      - name: 🧹 Remove existing Docker network if exists
        run: docker network rm tuttino_net || true

      - name: 🧹 Cleanup existing containers
        run: |
          docker rm -f tuttino-postgres || true
          docker rm -f tuttino-backend || true
          docker rm -f tuttino-nginx || true

      - name: 🚀 Terraform Apply
        run: terraform -chdir=infra apply -auto-approve

      - name: 🐳 Stop and Remove Existing Containers
        run: |
          docker stop tuttino-backend || true
          docker rm tuttino-backend || true
          docker network rm tuttino_net || true

      - name: 🐳 Build Docker Image
        run: docker build -t tuttino-backend:latest -f backend/dockerfile .

      - name: 🐳 Create Docker Network
        run: docker network create tuttino_net || true
